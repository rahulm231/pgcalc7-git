/*! WP Simple Pay Pro 3 - 3.2.3
 * https://wpsimplepay.com/
 * Copyright (c) Moonstone Media Group 2018
 * Licensed GPLv2+ */

var simpayAppPro={};!function(y){"use strict";var t;(simpayAppPro={init:function(){(t=y(document.body)).on("simpayFormVarsInitialized",function(n,t,a){simpayAppPro.setupValidation(t,a)}),t.on("simpayBindEventsAndTriggers",simpayAppPro.processForm),t.on("simpayFinalizeAmount",simpayAppPro.setFinalAmount)},processForm:function(n,t,a){(a=simpayApp.spFormData[a.formId]).taxAmount=simpayAppPro.calculateTaxAmount(a.amount,a.taxPercent),a.isSubscription&&"single"===a.subscriptionType&&(a.planAmount=a.amount),a.couponCode="",simpayAppPro.initDateField(t,a),simpayAppPro.updateTotalAmount(t,a),t.find(".simpay-custom-amount-input").on("keyup.simpayCustomAmountInput change.simpayCustomAmountInput",function(n){simpayAppPro.processCustomAmountInput(t,a),simpayAppPro.updateTotalAmount(t,a)}),t.find(".simpay-apply-coupon").on("click.simpayApplyCoupon",function(n){n.preventDefault(),simpayAppPro.applyCoupon(t,a),simpayAppPro.updateTotalAmount(t,a)}),t.find(".simpay-remove-coupon").on("click.simpayRemoveCoupon",function(n){n.preventDefault(),simpayAppPro.removeCoupon(t,a)}),t.find(".simpay-amount-dropdown, .simpay-amount-radio").on("change.simpayAmountSelect",function(n){simpayAppPro.updateAmountSelect(t,a)}),t.find(".simpay-quantity-dropdown, .simpay-quantity-radio").on("change.simpayQuantitySelect",function(){simpayAppPro.updateQuantitySelect(t,a)}),t.find(".simpay-quantity-input").on("keyup.simpayNumberQuantity, change.simpayNumberQuantity, input.simpayNumberQuantity",function(n){simpayAppPro.updateQuantitySelect(t,a),simpayAppPro.updateTotalAmount(t,a)}),t.find(".simpay-multi-sub, .simpay-plan-wrapper select").on("change.simpayMultiPlan",function(n){simpayAppPro.changeMultiSubAmount(t,a)}),t.find(".simpay-custom-amount-input").on("focus.simpayCustomAmountFocus",function(n){simpayAppPro.handleCustomAmountFocus(t,a)}),t.on("simpayCouponApplied",function(n){simpayAppPro.updateTotalAmount(t,a)}),t.on("simpayCouponRemoved",function(n){simpayAppPro.updateTotalAmount(t,a)}),t.on("simpayDropdownAmountChange",function(n){""===a.couponCode.trim()&&simpayAppPro.updateTotalAmount(t,a)}),t.on("simpayRadioAmountChange",function(n){""===a.couponCode.trim()&&simpayAppPro.updateTotalAmount(t,a)}),t.on("simpayDropdownQuantityChange",function(n){""===a.couponCode.trim()&&simpayAppPro.updateTotalAmount(t,a)}),t.on("simpayRadioQuantityChange",function(n){""===a.couponCode.trim()&&simpayAppPro.updateTotalAmount(t,a)}),t.on("simpayNumberQuantityChange",function(n){""===a.couponCode.trim()&&simpayAppPro.updateTotalAmount(t,a)}),t.on("simpayMultiPlanChanged",function(n){""===a.couponCode.trim()&&simpayAppPro.updateTotalAmount(t,a)}),t.on("simpayBeforeStripePayment",function(n,t,a){simpayAppPro.updateStripeParamsBeforesSubmitPayment(t,a)}),t.find(".simpay-custom-amount-input").trigger("change.simpayCustomAmountInput"),t.find(".simpay-amount-dropdown, .simpay-amount-radio").trigger("change.simpayAmountSelect"),t.find(".simpay-quantity-dropdown, .simpay-quantity-radio").trigger("change.simpayQuantitySelect"),t.find(".simpay-multi-sub:checked, .simpay-plan-wrapper select:selected").trigger("change.simpayMultiPlan"),t.find(".simpay-quantity-input").trigger("input.simpayNumberQuantity")},handleCustomAmountFocus:function(n,t){var a=n.find(".simpay-custom-plan-option"),o=n.find(".simpay-custom-amount-input");a.is("input")?a.prop("checked",!0):a.is("option")&&a.prop("selected",!0),t.useCustomPlan=!0,n.find(".simpay-has-custom-plan").val("true"),t.customPlanAmount=simpayApp.convertToCents(o.val())},updateStripeParamsBeforesSubmitPayment:function(n,t){t.isTrial&&0===t.finalAmount?t.stripeParams.panelLabel=t.freeTrialButtonText:t.stripeParams.panelLabel=t.oldPanelLabel},setupValidation:function(o){var n=o.data("simpay-form-id");y.validator.addMethod("minCheck",function(n,t,a){var o=spShared.unformatCurrency(n),i=spShared.unformatCurrency(a);return this.optional(t)||parseFloat(o)>=parseFloat(i)||""===o}),o.validate({errorPlacement:function(n,t){var a=o.find(t).data("error");a?o.find(a).append(n):n.insertAfter(o.find(t))},rules:{simpay_custom_amount:{required:!0,minCheck:simpayApp.formatMoney(spShared.unformatCurrency(simplePayForms[n].form.integers.minAmount))},simpay_subscription_custom_amount:{required:!0,minCheck:simpayApp.formatMoney(spShared.unformatCurrency(simplePayForms[n].form.integers.subMinAmount))}},messages:{simpay_custom_amount:simplePayForms[n].form.i18n.minCustomAmountError,simpay_subscription_custom_amount:simplePayForms[n].form.i18n.subMinCustomAmountError}}),t.trigger("simpayFormValidationInitialized",[o])},initDateField:function(n,t){n.find(".simpay-date-input").datepicker(),n.find(".simpay-date-input").datepicker("option","dateFormat",t.dateFormat)},processCustomAmountInput:function(n,t){var a=n.find(".simpay-custom-amount-input").val();t.isSubscription?(t.customAmount=simpayApp.convertToCents(spShared.unformatCurrency(""!==a?a:simpayApp.convertFromCents(t.subMinAmount))),t.customPlanAmount=t.customAmount,t.planAmount=t.customAmount):t.customAmount=simpayApp.convertToCents(spShared.unformatCurrency(""!==a?a:simpayApp.convertFromCents(t.minAmount))),simpayAppPro.applyCoupon(n,t)},setFinalAmount:function(n,t,a){var o=a.amount;"undefined"!==a.customAmount&&0<a.customAmount&&(o=spGeneral.booleans.isZeroDecimal?parseInt(a.customAmount):parseFloat(a.customAmount)),void 0!==a.isSubscription&&a.isSubscription&&(o="single"===a.subscriptionType?void 0!==a.customPlanAmount?a.customPlanAmount:a.amount:void 0!==a.useCustomPlan&&a.useCustomPlan?a.customPlanAmount:a.planAmount,a.isTrial&&(o=0),void 0!==a.setupFee&&(o+=a.setupFee),void 0!==a.planSetupFee&&(o+=a.planSetupFee)),void 0!==a.quantity&&(o*=a.quantity),void 0!==a.discount&&(o-=a.discount),void 0===a.isSubscription||a.isSubscription||(0<a.feePercent&&(o+=o*(a.feePercent/100)),0<a.feeAmount&&(o+=a.feeAmount)),0<a.taxPercent&&(a.taxAmount=simpayAppPro.calculateTaxAmount(o,a.taxPercent),o+=Math.round(a.taxAmount),t.find(".simpay-tax-amount").val(a.taxAmount)),a.finalAmount=o},applyCoupon:function(t,a){var n,o=t.find(".simpay-coupon-field"),i=t.find(".simpay-coupon-message"),p=t.find(".simpay-coupon-loading"),u=t.find(".simpay-remove-coupon"),e=t.find(".simpay-coupon"),m="",s="",r=a.amount,d=0;if(o.val())m=o.val();else{if(!a.couponCode)return;m=a.couponCode}a.isSubscription?(void 0!==a.setupFee?d=a.setupFee:void 0!==a.planSetupFee&&(d=a.planSetupFee),r=a.useCustomPlan?a.customPlanAmount+d:a.planAmount+d):"undefined"!==a.customAmount&&0<a.customAmount&&(r=a.customAmount),void 0!==a.quantity&&(r*=a.quantity),n={action:"simpay_get_coupon",coupon:m,amount:r,couponNonce:t.find("#simpay_coupon_nonce").val()},i.text(""),u.hide(),o.val(""),p.show(),y.ajax({url:spGeneral.strings.ajaxurl,method:"POST",data:n,dataType:"json",success:function(n){a.couponCode=m,a.discount=n.discount,a.couponDuration=n.coupon.duration,s=n.coupon.code+": ","percent"===n.coupon.type?s+=n.coupon.amountOff+spGeneral.i18n.couponPercentOffText:"amount"===n.coupon.type&&(s+=simpayApp.formatMoney(simpayApp.convertToCents(n.coupon.amountOff))+" "+spGeneral.i18n.couponAmountOffText),y(".coupon-details").remove(),i.append(s),y("<input />",{name:"simpay_coupon_details",type:"hidden",value:s,class:"simpay-coupon-details"}).appendTo(i),u.show(),e.val(m),p.hide(),t.trigger("simpayCouponApplied")},error:function(n){var t="";spShared.debugLog("Coupon error",n.responseText),n.responseText&&(t=n.responseText),i.append(y("<p />").addClass("simpay-field-error").text(t)),p.hide()}})},removeCoupon:function(n,t){n.find(".simpay-coupon-loading").hide(),n.find(".simpay-remove-coupon").hide(),n.find(".simpay-coupon-message").text(""),n.find(".simpay-coupon").val(""),t.couponCode="",t.discount=0,n.trigger("simpayCouponRemoved")},updateAmountSelect:function(n,t){n.find(".simpay-amount-dropdown").length?(t.amount=n.find(".simpay-amount-dropdown").find("option:selected").data("amount"),n.trigger("simpayDropdownAmountChange")):n.find(".simpay-amount-radio")&&(t.amount=n.find(".simpay-amount-radio").find('input[type="radio"]:checked').data("amount"),n.trigger("simpayRadioAmountChange")),simpayAppPro.applyCoupon(n,t)},updateQuantitySelect:function(n,t){t.quantity=1,n.find(".simpay-quantity-dropdown").length?(t.quantity=n.find(".simpay-quantity-dropdown").find("option:selected").data("quantity"),n.trigger("simpayDropdownQuantityChange")):n.find(".simpay-quantity-radio").length?(t.quantity=n.find(".simpay-quantity-radio").find('input[type="radio"]:checked').data("quantity"),n.trigger("simpayRadioQuantityChange")):n.find(".simpay-quantity-input").length&&(t.quantity=parseInt(n.find(".simpay-quantity-input").val()),n.trigger("simpayNumberQuantityChange")),t.quantity<1&&(t.quantity=1),n.find(".simpay-quantity").val(t.quantity),simpayAppPro.applyCoupon(n,t)},updateTotalAmount:function(n,t){simpayAppPro.setFinalAmount(null,n,t),n.find(".simpay-total-amount-value").text(simpayApp.formatMoney(t.finalAmount)),simpayAppPro.updateRecurringAmountLabel(n,t),simpayAppPro.updateTaxAmountLabel(n,t)},updateRecurringAmountLabel:function(n,t){var a,o=t.planAmount*t.quantity;"repeating"!==t.couponDuration&&"forever"!==t.couponDuration||(o-=t.discount),a=o+simpayAppPro.calculateTaxAmount(o,t.taxPercent),1<t.planIntervalCount?n.find(".simpay-total-amount-recurring-value").text(simpayApp.formatMoney(a)+" every "+t.planIntervalCount+" "+t.planInterval+"s"):n.find(".simpay-total-amount-recurring-value").text(simpayApp.formatMoney(a)+"/"+t.planInterval)},updateTaxAmountLabel:function(n,t){n.find(".simpay-tax-amount-value").text(simpayApp.formatMoney(t.taxAmount))},calculateTaxAmount:function(n,t){return n*(t/100)},changeMultiSubAmount:function(n,t){var a="",o=n.find(".simpay-custom-amount-input"),i=n.find(".simpay-plan-wrapper").find(".simpay-multi-sub"),p=0,u="",e=0,m="",s=1,r=!1,d=0;u=i.first().is("option")?(a=i.filter(":selected")).data("plan-id"):(a=i.filter(":checked")).data("plan-id"),p=a.data("plan-setup-fee"),e=a.data("plan-amount"),m=a.data("plan-interval"),s=a.data("plan-interval-count"),r=void 0!==a.data("plan-trial"),d=a.data("plan-max-charges"),"simpay_custom_plan"===a.val()?(t.useCustomPlan=!0,e=simpayApp.convertToCents(o.val())):t.useCustomPlan=!1,r&&(t.amount=0),t.planId=u,t.planSetupFee=p,t.planAmount=e,t.planInterval=m,t.planIntervalCount=s,t.isTrial=r,a.hasClass("simpay-custom-plan-option")?n.find(".simpay-has-custom-plan").val("true"):n.find(".simpay-has-custom-plan").val(""),t.useCustomPlan?(o.val(""),o.focus()):o.val(simpayApp.convertFromCents(e)),n.find(".simpay-multi-plan-id").val(u),n.find(".simpay-multi-plan-setup-fee").val(p),n.find(".simpay-max-charges").val(d),n.trigger("simpayMultiPlanChanged"),simpayAppPro.applyCoupon(n,t)}}).init()}(jQuery);